# GEARS模型工作原理及scFoundation集成

## 一、基因嵌入表示的两种方式

### 1. 原始GEARS（不使用scFoundation）

使用**基于基因ID的固定嵌入**：
- 每个基因有一个可学习的嵌入向量（`gene_emb`），类似词嵌入
- 这个嵌入是**静态的**，与当前表达值无关
- 同一个基因在不同样本中的初始嵌入相同

### 2. 使用scFoundation

生成**上下文感知的动态嵌入**：
- 将整个细胞的表达谱（19,264个基因）输入scFoundation
- 通过MAE Autobin架构，为每个基因生成嵌入
- 这个嵌入是**动态的**，能够：
  - 感知基因间的相互作用关系
  - 反映当前细胞的整体表达状态
  - 捕获基因在特定表达背景下的上下文信息
- scFoundation的输出既作为基因嵌入，也可作为位置嵌入（根据v1/v2模式选择）

## 二、GEARS模型核心机制

### 1. 图神经网络（GNN）架构

GEARS利用两个生物学先验知识图：

#### 共表达图（G_coexpress）
- **来源**：从训练数据中计算基因间的皮尔逊相关系数
- **构建**：相关性 > 阈值（如0.4）的基因对连边
- **作用**：捕获"哪些基因倾向于一起表达"的数据驱动模式

#### 基因本体论图（G_go）
- **来源**：生物学知识库（Gene Ontology数据库）
- **构建**：基于基因功能注释的Jaccard相似度
- **作用**：融合"哪些基因功能相关"的专家知识

### 2. 信息传播流程

```
基因嵌入（来自scFoundation或gene_emb）
    ↓
GNN层1：在共表达图上聚合邻居信息
    ↓ ReLU
GNN层2：信息传播到更远的邻居
    ↓
增强后的基因嵌入（包含网络上下文）
```

每层GNN的更新规则：
```
新嵌入_i = 旧嵌入_i + Σ(权重_ij × 邻居_j的嵌入)
```

扰动嵌入也通过类似方式在GO图上增强。

## 三、扰动预测流程

### 输入
- `x`：对照表达值（baseline）
- `pert_idx`：扰动信息（哪些基因被敲除/过表达）

### 核心步骤

#### 步骤1：基因嵌入初始化
- **原始GEARS**：基因ID → 固定嵌入
- **scFoundation版本**：表达谱 → 动态嵌入

#### 步骤2：通过GNN增强嵌入
- 在共表达图上传播，让基因互相"交流"
- 融合：`base_emb = base_emb + 0.2 * pos_emb`

#### 步骤3：融合扰动信息
- 扰动嵌入通过GO图增强
- 对于组合扰动，将多个扰动嵌入相加
- 通过MLP融合后，加到对应样本的所有基因嵌入上

#### 步骤4：预测表达变化量Δ
- **共享解码器**（`recovery_w`）：所有基因共同的响应模式
- **基因特异性解码器**（`indv_w1/b1`）：每个基因的个性化调整
- **跨基因交互**（`cross_gene_state`）：学习全局细胞状态
- **最终解码器**（`indv_w2/b2`）：输出变化量Δ

#### 步骤5：残差连接得到最终预测
```
扰动后表达值 = 对照表达值(x) + 预测变化量(Δ)
```

## 四、关键创新点

### 1. 不直接使用表达值预测绝对值，而是预测变化量
- **优势**：任务更简单，学习增量比学习绝对值更容易
- 类似残差学习（ResNet）的思想
- x作为基线，模型只需学习扰动带来的偏移

### 2. 多层次的基因特异性建模
- **共享层**：学习通用扰动响应模式
- **基因特异层**：为19,264个基因各自学习独立参数
- **跨基因交互**：捕获基因间的协同效应

### 3. 融合多源信息
- **数据驱动**：共表达网络、scFoundation学习的模式
- **知识驱动**：基因本体论、生物学先验
- 两者通过GNN有机结合

## 五、scFoundation的提升

相比原始GEARS的静态嵌入，scFoundation提供的动态嵌入能够：
- 捕获细胞的当前状态
- 反映基因在特定表达背景下的角色
- 提供更丰富的初始表示，为后续GNN和解码器提供更好的起点

## 六、数据流图总结

```
输入：对照表达值(x) + 扰动信息(pert_idx)
    ↓
【嵌入初始化】
  原始: 基因ID → 固定嵌入
  scF:  表达谱 → 动态嵌入
    ↓
【GNN增强】
  共表达图传播 → 包含邻居信息的嵌入
    ↓
【扰动融合】
  GO图增强扰动嵌入 → 加到对应样本
    ↓
【解码预测】
  共享MLP → 基因特异 → 跨基因交互 → Δ
    ↓
【残差连接】
  Δ + x → 扰动后表达值
```

---

**文档创建时间**: 2025-10-23
**项目**: GEARS with scFoundation Integration
